# bot.py
import os
import logging
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ –º–æ–¥—É–ª–∏
from database import db
from payments import yookassa

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
TOKEN = os.getenv('TELEGRAM_TOKEN')
if not TOKEN:
    print("‚ùå –û–®–ò–ë–ö–ê: TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print("üëâ –î–æ–±–∞–≤—å—Ç–µ –≤ Render: TELEGRAM_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞")
    exit(1)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
FREE_LIMIT = 5
ADMIN_ID = 123456789  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à ID

# ========== –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ==========

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_id = db.get_or_create_user(user.id, user.username, user.first_name, user.last_name)
    
    keyboard = [
        [InlineKeyboardButton("‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", callback_data="create")],
        [InlineKeyboardButton("üìã –ú–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", callback_data="list")],
        [InlineKeyboardButton("üíé –ü—Ä–µ–º–∏—É–º", callback_data="premium_info")],
        [InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data="help")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f"üîî <b>–ù–µ–ó–∞–±—É–¥—å–û–ø–ª–∞—Ç–∏—Ç—å</b>\n\n"
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}!\n\n"
        f"‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!\n"
        f"‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞\n"
        f"‚úÖ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup,
        parse_mode='HTML'
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    help_text = (
        "<b>üîî –ù–µ–ó–∞–±—É–¥—å–û–ø–ª–∞—Ç–∏—Ç—å ‚Äî –ø–æ–º–æ—â—å</b>\n\n"
        "<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "‚Ä¢ /start ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
        "‚Ä¢ /new ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
        "‚Ä¢ /list ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\n"
        "‚Ä¢ /premium ‚Äî –ø—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞\n"
        "‚Ä¢ /status ‚Äî —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞\n"
        "‚Ä¢ /help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "<b>–°–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n"
        "‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã\n"
        "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\n"
        f"{'‚úÖ –ÆKassa' if yookassa.is_configured() else '‚ö†Ô∏è –ÆKassa (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)'}\n\n"
        "<i>–ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç! üöÄ</i>"
    )
    
    await update.message.reply_text(help_text, parse_mode='HTML')

# ========== –†–ê–ë–û–ß–ê–Ø –ö–û–ú–ê–ù–î–ê /NEW ==========

async def new_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /new"""
    user = update.effective_user
    user_id = db.get_or_create_user(user.id, user.username, user.first_name, user.last_name)
    
    await update.message.reply_text(
        "üìù <b>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</b>\n\n"
        "–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!\n\n"
        "–ê –ø–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
        "‚Ä¢ /status ‚Äî —Å—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞\n"
        "‚Ä¢ /list ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\n"
        "‚Ä¢ /premium ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ\n\n"
        "<i>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è —Å–∫–æ—Ä–æ! üîß</i>",
        parse_mode='HTML'
    )

# ========== –†–ê–ë–û–ß–ê–Ø –ö–û–ú–ê–ù–î–ê /LIST ==========

async def list_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /list"""
    user = update.effective_user
    user_id = db.get_or_create_user(user.id, user.username, user.first_name, user.last_name)
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    try:
        reminders = db.get_user_reminders(user_id)
        if reminders:
            message = "üìã <b>–í–∞—à–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>\n\n"
            for rem in reminders[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
                message += f"‚Ä¢ {rem.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}\n"
                message += f"  üí∞ {rem.get('amount', 0)}‚ÇΩ\n"
                message += f"  üìÖ {rem.get('payment_date', '–ù–µ—Ç –¥–∞—Ç—ã')}\n\n"
            message += f"<i>–í—Å–µ–≥–æ: {len(reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</i>"
        else:
            message = "üì≠ <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</b>\n\n–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!"
    except Exception as e:
        message = f"üìã <b>–°–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</b>\n\n‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n–§—É–Ω–∫—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.\n\n–û—à–∏–±–∫–∞: {str(e)[:50]}"
    
    await update.message.reply_text(message, parse_mode='HTML')

# ========== –†–ê–ë–û–ß–ê–Ø –ö–û–ú–ê–ù–î–ê /PREMIUM ==========

async def premium_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /premium"""
    user = update.effective_user
    user_id = db.get_or_create_user(user.id, user.username, user.first_name, user.last_name)
    
    yookassa_status = "‚úÖ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞" if yookassa.is_configured() else "‚ö†Ô∏è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
    
    keyboard = [
        [InlineKeyboardButton("üíé –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="premium_info")],
        [InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å", callback_data="premium_status")]
    ]
    
    if not yookassa.is_configured():
        keyboard.append([InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–ø–ª–∞—Ç—É", url="https://yookassa.ru")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f"üíé <b>–ü–†–ï–ú–ò–£–ú –ü–û–î–ü–ò–°–ö–ê</b>\n\n"
        f"<b>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã:</b> {yookassa_status}\n\n"
        f"<b>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–µ–º–∏—É–º–∞:</b>\n"
        f"‚Ä¢ ‚ôæÔ∏è –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
        f"‚Ä¢ üîÑ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–ª–∞—Ç–µ–∂–∏\n"
        f"‚Ä¢ üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 3 –∏ 7 –¥–Ω–µ–π\n"
        f"‚Ä¢ üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n\n"
        f"<b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b>\n"
        f"‚Ä¢ 1 –º–µ—Å—è—Ü ‚Äî 299‚ÇΩ\n"
        f"‚Ä¢ 3 –º–µ—Å—è—Ü–∞ ‚Äî 799‚ÇΩ\n"
        f"‚Ä¢ 12 –º–µ—Å—è—Ü–µ–≤ ‚Äî 1990‚ÇΩ\n\n"
        f"<i>–°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!</i>",
        reply_markup=reply_markup,
        parse_mode='HTML'
    )

# ========== –ö–û–ú–ê–ù–î–ê /STATUS ==========

async def status_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /status"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        db_ok = db.init_db()
        yookassa_ok = yookassa.is_configured()
        
        status_text = (
            f"<b>üìä –°–¢–ê–¢–£–° –ë–û–¢–ê</b>\n\n"
            f"<b>ü§ñ Telegram API:</b> ‚úÖ –ø–æ–¥–∫–ª—é—á–µ–Ω\n"
            f"<b>üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</b> {'‚úÖ —Ä–∞–±–æ—Ç–∞–µ—Ç' if db_ok else '‚ö†Ô∏è –ø—Ä–æ–±–ª–µ–º—ã'}\n"
            f"<b>üí≥ –ÆKassa:</b> {'‚úÖ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' if yookassa_ok else '‚ö†Ô∏è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}\n"
            f"<b>üìÖ –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n\n"
            f"<b>–†–∞–±–æ—Ç–∞—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            f"‚úÖ /start ‚Äî –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞\n"
            f"‚úÖ /help ‚Äî –ø–æ–º–æ—â—å\n"
            f"‚úÖ /new ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
            f"‚úÖ /list ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\n"
            f"‚úÖ /premium ‚Äî –ø—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞\n"
            f"‚úÖ /status ‚Äî —ç—Ç–æ—Ç —Å—Ç–∞—Ç—É—Å\n\n"
            f"<i>–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç! üéâ</i>"
        )
        
        await update.message.reply_text(status_text, parse_mode='HTML')
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–º–∞–Ω–¥—ã status: {e}")
        await update.message.reply_text(
            f"‚ö†Ô∏è <b>–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞</b>\n\n"
            f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:\n<code>{str(e)[:100]}</code>\n\n"
            f"–ù–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã.",
            parse_mode='HTML'
        )

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–û–ö ==========

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    if query.data == "premium_info":
        await query.edit_message_text(
            "üíé <b>–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–º–∏—É–º–µ</b>\n\n"
            "–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ÆKassa.\n\n"
            "–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n"
            "1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ yookassa.ru\n"
            "2. –ü–æ–ª—É—á–∏—Ç–µ shop_id –∏ secret_key\n"
            "3. –î–æ–±–∞–≤—å—Ç–µ –≤ Render –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:\n"
            "   ‚Ä¢ YOOKASSA_SHOP_ID\n"
            "   ‚Ä¢ YOOKASSA_SECRET_KEY\n\n"
            "<i>–°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±–æ—Ç–∞!</i>",
            parse_mode='HTML'
        )
    elif query.data == "premium_status":
        await query.edit_message_text(
            "üîÑ <b>–°—Ç–∞—Ç—É—Å –≤–∞—à–µ–≥–æ –ø—Ä–µ–º–∏—É–º–∞</b>\n\n"
            "–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã.\n\n"
            "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!",
            parse_mode='HTML'
        )
    elif query.data == "help":
        await help_command_with_query(query)
    elif query.data == "create":
        await query.edit_message_text(
            "–ù–∞–∂–º–∏—Ç–µ /new –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
            parse_mode='HTML'
        )
    elif query.data == "list":
        await query.edit_message_text(
            "–ù–∞–∂–º–∏—Ç–µ /list –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π",
            parse_mode='HTML'
        )

async def help_command_with_query(query):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–º–æ—â–∏"""
    await query.edit_message_text(
        "<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
        "/new - —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
        "/list - —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\n"
        "/premium - –ø—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞\n"
        "/status - —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞\n"
        "/help - –ø–æ–º–æ—â—å\n\n"
        "<i>–í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç! üöÄ</i>",
        parse_mode='HTML'
    )

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"–û—à–∏–±–∫–∞ –±–æ—Ç–∞: {context.error}", exc_info=True)
    
    try:
        if update and update.effective_message:
            await update.effective_message.reply_text(
                "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start"
            )
    except:
        pass

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    print("=" * 50)
    print("üöÄ –ó–ê–ü–£–°–ö –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢–ê ¬´–ù–µ–ó–∞–±—É–¥—å–û–ø–ª–∞—Ç–∏—Ç—å¬ª")
    print("=" * 50)
    
    print(f"‚úÖ –¢–æ–∫–µ–Ω: {'–Ω–∞–π–¥–µ–Ω' if TOKEN else '–ù–ï –ù–ê–ô–î–ï–ù'}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
    try:
        if db.init_db():
            print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
        else:
            print("‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ë–î: {e}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ÆKassa
    print(f"üí≥ –ÆKassa: {'–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' if yookassa.is_configured() else '–ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}")
    
    if not yookassa.is_configured():
        print("üëâ –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã –¥–æ–±–∞–≤—å—Ç–µ –≤ Render:")
        print("   ‚Ä¢ YOOKASSA_SHOP_ID")
        print("   ‚Ä¢ YOOKASSA_SECRET_KEY")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = Application.builder().token(TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("new", new_command))
    app.add_handler(CommandHandler("list", list_command))
    app.add_handler(CommandHandler("premium", premium_command))
    app.add_handler(CommandHandler("status", status_command))
    app.add_handler(CallbackQueryHandler(button_handler))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    app.add_error_handler(error_handler)
    
    print("‚úÖ –ö–æ–º–∞–Ω–¥—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
    print("üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /start, /help, /new, /list, /premium, /status")
    print("=" * 50)
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    
    app.run_polling()

if __name__ == "__main__":
    main()
